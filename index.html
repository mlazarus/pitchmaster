<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitch Game Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; color: #202124; }
        .header { background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%); color: white; padding: 1.25rem 2rem; }
        .tabs { display: flex; gap: 0.5rem; margin: 1.5rem 2rem 0; border-bottom: 2px solid #dadce0; }
        .tab { padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: #5f6368; border-bottom: 3px solid transparent; font-family: inherit; position: relative; bottom: -2px; }
        .tab.active { color: #1a73e8; border-bottom-color: #1a73e8; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; background: #1a73e8; color: white; margin-right: 0.5rem; margin-top: 0.5rem; }
        input { width: 100%; padding: 0.75rem; border: 2px solid #dadce0; border-radius: 8px; font-size: 1rem; margin-bottom: 0.5rem; }
        .player-item { display: flex; justify-content: space-between; padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; }
        .team-badge { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .team-a { background: #e8f5e9; color: #34a853; }
        .team-b { background: #fff3e0; color: #f57c00; }
        .score-display { font-size: 3rem; font-weight: 700; color: #34a853; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #dadce0; }
#hands-table td { padding: 0.4rem 0.5rem; }
#hands-table th { padding: 0.4rem 0.5rem; }
        
        th { background: #f8f9fa; font-weight: 600; }
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; }
        .toast.show { display: block; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .dealer-select-item { padding: 1rem; margin: 0.5rem 0; background: #f8f9fa; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
        .dealer-select-item:hover { background: #e8f5e9; }
        .dealer-select-item.selected { background: #1a73e8; color: white; font-weight: 600; }
        .dealer-order-badge { background: white; color: #1a73e8; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: 700; font-size: 0.875rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ® Pitch Game Tracker</h1>
        <div style="margin-top: 0.5rem;">
            <label style="color: white; margin-right: 0.5rem;">Table:</label>
            <select id="table-select" style="padding: 0.5rem; border-radius: 6px; border: none; font-size: 1rem; cursor: pointer;">
                <option value="1">Table 1</option>
                <option value="2">Table 2</option>
                <option value="3">Table 3</option>
                <option value="4">Table 4</option>
            </select>
        </div>
    </div>
    <div class="tabs">
        <button class="tab active" data-tab="game">Game</button>
        <button class="tab" data-tab="players">Players</button>
        <button class="tab" data-tab="stats">Stats</button>
        <button class="tab" data-tab="settings">Settings</button>
        <button class="tab" data-tab="about">About</button>
        <button class="btn" onclick="window.open('pitch_player_stats.html', '_blank')" style="background: #9334e9;">ðŸ“Š Player Stats</button>
    </div>
    <div class="container">
        <div id="content-game" class="tab-content active">
            <div class="card">
                <h2>Game #<span id="game-number">1</span></h2>
                <p><strong>Current Dealer:</strong> <span id="current-dealer">Not selected</span></p>
                <div id="dealer-rotation" style="display: none; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <strong>Dealer Rotation:</strong>
                    <div id="dealer-list" style="margin-top: 0.5rem; display: flex; gap: 1rem; flex-wrap: wrap;"></div>
                </div>
                
                <button class="btn" id="btn-add-score">Add Score</button>
                <button class="btn" id="btn-dealers" style="background: #34a853;">Select Dealers</button>
                <button class="btn" id="btn-reset-dealers" style="background: #f57c00;">Reset Dealers</button>
                <button class="btn" id="btn-end-game" style="background: #ea4335;">End Game</button>
                <h3 style="margin-top: 2rem;">Scores</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                    <div><h4>Team A</h4><div class="score-display" id="total-a">0</div><div id="players-a">No players</div></div>
                    <div><h4>Team B</h4><div class="score-display" id="total-b" style="color: #f57c00;">0</div><div id="players-b">No players</div></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-top: 2rem;">
    <div>
        <h3>Hands</h3>
        <tabble style="width: 100%;"><thead><tr><th style="width: 50%; padding: 0.5rem;">Dealer</th><th style="width: 25%; padding: 0.5rem;">A</th><th style="width: 25%; padding: 0.5rem;">B</th></tr></thead><tbody id="hands-table"><tr><td colspan="3" style="padding: 0.5rem;">No hands yet</td></tr></tbody></table>

            
            </div>
    <div>
        <div id="total-summary">
            <h3>Total Summary</h3>
            <table><thead><tr><th>Team</th><th>Players</th><th>Game 1</th><th>Game 2</th><th>Game 3</th><th>Total</th></tr></thead><tbody id="summary-body"><tr><td>A</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr><tr><td>B</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr></tbody></table>
        </div>
        <div style="margin-top: 2rem;">
            <h3>Sets</h3>
            <table><thead><tr id="sets-header"><th>Set #</th></tr></thead><tbody id="sets-body"><tr><td colspan="10">No sets yet</td></tr></tbody></table>
        </div>
    </div>
</div>
            </div>
        </div>
        <div id="content-players" class="tab-content">
            <div class="card">
                <h2>Manage Players</h2>
                <input type="text" id="new-player-name" placeholder="Player name" maxlength="8">
                <button class="btn" id="btn-add-player">Add Player</button>
                <h3 style="margin-top: 2rem;">Players</h3>
                <div id="player-list"></div>
                <p style="margin-top: 1rem; color: #5f6368; font-size: 0.875rem;">Click: None â†’ Team A â†’ Team B â†’ None</p>
            </div>
        </div>
        <div id="content-stats" class="tab-content">
            <div class="card">
                <h2>Statistics</h2>
                <p>Games: <span id="stat-games">0</span></p>
                <p>Hands: <span id="stat-hands">0</span></p>
                <h3 style="margin-top: 2rem;">Set History</h3>
                <table><thead><tr><th>Set</th><th>Team A</th><th>Team B</th><th>A Score</th><th>B Score</th><th>Winner</th></tr></thead><tbody id="set-history-body"><tr><td colspan="6">No sets yet</td></tr></tbody></table>
            </div>
        </div>
        <div id="content-settings" class="tab-content">
            <div class="card">
                <h2>Settings - Stakes</h2>
                <label><strong>Game:</strong></label>
                <input type="number" id="stake-game" value="4" min="0" step="1">
                <label><strong>Bump:</strong></label>
                <input type="number" id="stake-bump" value="2" min="0" step="1">
                <label><strong>Points:</strong></label>
                <input type="number" id="stake-points" value="1" min="0" step="0.5">
                <label><strong>Bonus:</strong></label>
                <input type="number" id="stake-bonus" value="25" min="0" step="1">
                <button class="btn" id="btn-save-stakes">Save Stakes</button>
            </div>
        </div>
<div id="content-about" class="tab-content">
    <div class="card">
        <h2>About Pitch Game Tracker</h2>
        <div style="margin-top: 2rem;">
            <div style="display: flex; justify-content: space-between; padding: 1rem 0; border-bottom: 1px solid #dadce0;">
                <span style="font-weight: 600; color: #5f6368;">Version</span>
                <span style="color: #202124;">1.5.0</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 1rem 0; border-bottom: 1px solid #dadce0;">
                <span style="font-weight: 600; color: #5f6368;">Last Updated</span>
                <span style="color: #202124;">January 17, 2026</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 1rem 0;">
                <span style="font-weight: 600; color: #5f6368;">Description</span>
                <span style="color: #202124;">Multi-table pitch game scoring system</span>
            </div>
        </div>
    </div>
</div>

        
    </div>
    <div class="toast" id="toast"></div>

<div class="modal" id="score-modal">
    <div class="modal-content">
        <h2>Add Score</h2>
        <p style="color: #5f6368; margin: 1rem 0;">Enter scores for this hand</p>
        <label><strong>Team A Score:</strong></label>
        <input type="number" id="score-a-modal" placeholder="Team A Score" step="0.5" style="width: 100%; margin-bottom: 1rem;">
        <label><strong>Team B Score:</strong></label>
        <input type="number" id="score-b-modal" placeholder="Team B Score" step="0.5" style="width: 100%; margin-bottom: 1rem;">
        <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
            <button class="btn" id="btn-confirm-score">Add Score</button>
            <button class="btn" id="btn-cancel-score" style="background: #5f6368;">Cancel</button>
        </div>
    </div>
</div>
    
    <div class="modal" id="dealer-modal">
        <div class="modal-content">
            <h2>Select Dealer Order</h2>
            <p style="color: #5f6368; margin: 1rem 0;">Click players in order (4 dealers needed)</p>
            <div id="dealer-selection-list"></div>
            <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
                <button class="btn" id="btn-confirm-dealers">Confirm</button>
                <button class="btn" id="btn-cancel-dealers" style="background: #5f6368;">Cancel</button>
            </div>
        </div>
    </div>
    <script>
var sb = window.supabase.createClient('https://lhlnjggrljdgmytmoaqb.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxobG5qZ2dybGpkZ215dG1vYXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjUwNjAsImV4cCI6MjA4MzkwMTA2MH0.61TrFDb3XD14y26_aOhMqcrmgORDnrB7OmRdGlABgKI');
var g = { players: [], teamA: [], teamB: [], dealers: [], hands: [], gameNumber: 1, currentGameId: null, completedGames: [], setHistory: [], currentSetGames: [] };
var stakes = { gameScore: 4, bump: 2, points: 1, bonus: 25 };
var tempDealers = [];
var currentTable = 1;
var tables = {
    1: null,
    2: null,
    3: null,
    4: null
};

function toast(m) { var t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(function() { t.classList.remove('show'); }, 2000); }

document.querySelectorAll('.tab').forEach(function(tab) {
    tab.onclick = function() {
        var target = this.getAttribute('data-tab');
        document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        this.classList.add('active');
        document.getElementById('content-' + target).classList.add('active');
    };
});

document.getElementById('table-select').onchange = function() {
    saveCurrentTable();
    currentTable = parseInt(this.value);
    loadTable(currentTable);
};

function saveCurrentTable() {
    tables[currentTable] = {
        teamA: g.teamA.slice(),
        teamB: g.teamB.slice(),
        dealers: g.dealers.slice(),
        hands: g.hands.slice(),
        gameNumber: g.gameNumber,
        currentGameId: g.currentGameId,
        currentSetGames: g.currentSetGames.slice()
    };
}

function loadTable(tableNum) {
    if (tables[tableNum]) {
        g.teamA = tables[tableNum].teamA.slice();
        g.teamB = tables[tableNum].teamB.slice();
        g.dealers = tables[tableNum].dealers.slice();
        g.hands = tables[tableNum].hands.slice();
        g.gameNumber = tables[tableNum].gameNumber;
        g.currentGameId = tables[tableNum].currentGameId;
        g.currentSetGames = tables[tableNum].currentSetGames.slice();
    } else {
        g.teamA = [];
        g.teamB = [];
        g.dealers = [];
        g.hands = [];
        g.gameNumber = 1;
        g.currentGameId = null;
        g.currentSetGames = [];
        loadGameForTable(tableNum);
    }
    updateUI();
}

function loadGameForTable(tableNum) {
    sb.from('games').select('*').is('winner', null).eq('table_number', tableNum).order('created_at', { ascending: false }).limit(1).then(function(r) {
        if (r.data && r.data.length > 0) {
            var game = r.data[0];
            g.currentGameId = game.id;
            g.gameNumber = game.game_number;
            g.teamA = game.team_a_players || [];
            g.teamB = game.team_b_players || [];
            return sb.from('hands').select('*').eq('game_id', game.id).order('hand_order').then(function(r2) {
                g.hands = r2.data ? r2.data.map(function(h) { return { dealer: h.dealer, scoreA: parseFloat(h.score_a), scoreB: parseFloat(h.score_b) }; }) : [];
                updateUI();
            });
        } else {
            sb.from('games').select('game_number').eq('table_number', tableNum).order('game_number', { ascending: false }).limit(1).then(function(r2) {
                var num = r2.data && r2.data.length > 0 ? r2.data[0].game_number + 1 : 1;
                return sb.from('games').insert({ game_number: num, table_number: tableNum, team_a_players: g.teamA, team_b_players: g.teamB }).select().single().then(function(r3) {
                    if (r3.data) {
                        g.currentGameId = r3.data.id;
                        g.gameNumber = r3.data.game_number;
                    }
                    updateUI();
                });
            });
        }
    });
}

function load() {
    sb.from('players').select('*').order('name').then(function(r) { g.players = r.data ? r.data.map(function(p) { return p.name; }) : []; return sb.from('stakes').select('*').limit(1).single(); }).then(function(r) {
        if (r.data) { stakes.gameScore = parseFloat(r.data.game_score) || 4; stakes.bump = parseFloat(r.data.bump) || 2; stakes.points = parseFloat(r.data.points) || 1; stakes.bonus = parseFloat(r.data.bonus) || 25; document.getElementById('stake-game').value = stakes.gameScore; document.getElementById('stake-bump').value = stakes.bump; document.getElementById('stake-points').value = stakes.points; document.getElementById('stake-bonus').value = stakes.bonus; }
        return sb.from('games').select('*').is('winner', null).eq('table_number', currentTable).order('created_at', { ascending: false }).limit(1);
    }).then(function(r) {
        if (r.data && r.data.length > 0) { var game = r.data[0]; g.currentGameId = game.id; g.gameNumber = game.game_number; g.teamA = game.team_a_players || []; g.teamB = game.team_b_players || []; return sb.from('hands').select('*').eq('game_id', game.id).order('hand_order').then(function(r2) { g.hands = r2.data ? r2.data.map(function(h) { return { dealer: h.dealer, scoreA: parseFloat(h.score_a), scoreB: parseFloat(h.score_b) }; }) : []; }); }
        else { return sb.from('games').select('game_number').eq('table_number', currentTable).order('game_number', { ascending: false }).limit(1).then(function(r2) { var num = r2.data && r2.data.length > 0 ? r2.data[0].game_number + 1 : 1; return sb.from('games').insert({ game_number: num, table_number: currentTable, team_a_players: g.teamA, team_b_players: g.teamB }).select().single().then(function(r3) { if (r3.data) { g.currentGameId = r3.data.id; g.gameNumber = r3.data.game_number; } }); }); }
    }).then(function() { return sb.from('games').select('*').not('winner', 'is', null).eq('table_number', currentTable).order('completed_at', { ascending: false }).limit(10); }).then(function(r) {
        g.completedGames = r.data ? r.data.map(function(game) { return { gameNumber: game.game_number, winner: game.winner, scoreA: parseFloat(game.score_a), scoreB: parseFloat(game.score_b), handsPlayed: game.hands_played, teamA: game.team_a_players, teamB: game.team_b_players }; }) : [];
        return sb.from('sets').select('*').eq('table_number', currentTable).order('completed_at', { ascending: false });
    }).then(function(r) { g.setHistory = r.data ? r.data.map(function(s) { return { teamA: s.team_a_players, teamB: s.team_b_players, teamAScore: parseFloat(s.team_a_score), teamBScore: parseFloat(s.team_b_score) }; }) : []; updateUI(); });
}

function updateUI() {
    document.getElementById('players-a').textContent = g.teamA.join(', ') || 'No players';
    document.getElementById('players-b').textContent = g.teamB.join(', ') || 'No players';
    var totA = 0, totB = 0; g.hands.forEach(function(h) { totA += h.scoreA; totB += h.scoreB; });
    document.getElementById('total-a').textContent = totA.toFixed(1);
    document.getElementById('total-b').textContent = totB.toFixed(1);
    var tb = document.getElementById('hands-table');
    if (g.hands.length === 0) { tb.innerHTML = '<tr><td colspan="3">No hands yet</td></tr>'; }
    else { var rA = 0, rB = 0; tb.innerHTML = g.hands.map(function(h) { rA += h.scoreA; rB += h.scoreB; return '<tr><td>' + h.dealer + '</td><td>' + rA.toFixed(1) + '</td><td>' + rB.toFixed(1) + '</td></tr>'; }).join(''); }
    if (g.dealers.length > 0) {
        var currentDealerIdx = g.hands.length % g.dealers.length;
        document.getElementById('current-dealer').textContent = g.dealers[currentDealerIdx];
        document.getElementById('dealer-rotation').style.display = 'block';
        var dealerListHtml = g.dealers.map(function(d, i) {
            var isCurrent = i === currentDealerIdx;
            var style = 'padding: 0.5rem 1rem; background: ' + (isCurrent ? '#1a73e8' : 'white') + '; color: ' + (isCurrent ? 'white' : '#202124') + '; border-radius: 8px; font-weight: ' + (isCurrent ? '700' : '400') + ';';
            return '<div style="' + style + '">' + (isCurrent ? 'â˜… ' : '') + d + '</div>';
        }).join('');
        document.getElementById('dealer-list').innerHTML = dealerListHtml;
    } else {
        document.getElementById('current-dealer').textContent = 'Not selected';
        document.getElementById('dealer-rotation').style.display = 'none';
    }
    document.getElementById('game-number').textContent = g.gameNumber;
    var list = document.getElementById('player-list'); list.innerHTML = '';
    if (g.players.length === 0) { list.innerHTML = '<p style="color: #5f6368;">No players yet. Add one above!</p>'; }
    else { g.players.forEach(function(p) { var d = document.createElement('div'); d.className = 'player-item'; var b = ''; if (g.teamA.includes(p)) b = '<span class="team-badge team-a">Team A</span>'; else if (g.teamB.includes(p)) b = '<span class="team-badge team-b">Team B</span>'; d.innerHTML = '<span>' + p + '</span>' + b; d.onclick = function() { toggleTeam(p); }; list.appendChild(d); }); }
    document.getElementById('stat-games').textContent = g.completedGames.length;
    var th = 0; g.completedGames.forEach(function(game) { th += game.handsPlayed || 0; }); document.getElementById('stat-hands').textContent = th;
    if (g.currentSetGames.length > 0) { document.getElementById('total-summary').style.display = 'block'; var sA = ['', '', ''], sB = ['', '', ''], tA = 0, tB = 0; g.currentSetGames.forEach(function(game, i) { sA[i] = game.scoreA.toFixed(1); sB[i] = game.scoreB.toFixed(1); tA += game.scoreA; tB += game.scoreB; }); document.getElementById('summary-body').innerHTML = '<tr><td>A</td><td>' + g.teamA.join(', ') + '</td><td>' + sA[0] + '</td><td>' + sA[1] + '</td><td>' + sA[2] + '</td><td><strong>' + tA.toFixed(1) + '</strong></td></tr><tr><td>B</td><td>' + g.teamB.join(', ') + '</td><td>' + sB[0] + '</td><td>' + sB[1] + '</td><td>' + sB[2] + '</td><td><strong>' + tB.toFixed(1) + '</strong></td></tr>'; }
    if (g.setHistory.length > 0) { document.getElementById('set-history-body').innerHTML = g.setHistory.map(function(s, i) { var w = s.teamAScore > s.teamBScore ? 'Team A' : 'Team B'; return '<tr><td>' + (i + 1) + '</td><td>' + s.teamA.join(', ') + '</td><td>' + s.teamB.join(', ') + '</td><td>' + s.teamAScore.toFixed(1) + '</td><td>' + s.teamBScore.toFixed(1) + '</td><td><strong>' + w + '</strong></td></tr>'; }).join(''); }
}

function toggleTeam(p) { var inA = g.teamA.includes(p), inB = g.teamB.includes(p); if (!inA && !inB) { if (g.teamA.length >= 3) { toast('Team A full'); return; } g.teamA.push(p); toast(p + ' â†’ A'); } else if (inA) { if (g.teamB.length >= 3) { toast('Team B full'); return; } g.teamA = g.teamA.filter(function(x) { return x !== p; }); g.teamB.push(p); toast(p + ' â†’ B'); } else { g.teamB = g.teamB.filter(function(x) { return x !== p; }); toast(p + ' removed'); } if (g.currentGameId) sb.from('games').update({ team_a_players: g.teamA, team_b_players: g.teamB }).eq('id', g.currentGameId).then(function() {}); updateUI(); }

document.getElementById('btn-add-player').onclick = function() { 
    var n = document.getElementById('new-player-name').value.trim(); 
    if (!n) { toast('Enter name'); return; } 
    if (g.players.includes(n)) { toast('Player exists'); return; } 
    sb.from('players').insert({ name: n }).then(function(result) { 
        if (result.error) {
            toast('Error: ' + result.error.message);
            return;
        }
        g.players.push(n); 
        document.getElementById('new-player-name').value = ''; 
        updateUI(); 
        toast(n + ' added!'); 
    }); 
};


        
document.getElementById('btn-dealers').onclick = function() { 
    var all = g.teamA.concat(g.teamB); 
    if (all.length < 4) { toast('Need 4+ players'); return; }
    tempDealers = [];
    showDealerModal(all);
};

function showDealerModal(players) {
    var modal = document.getElementById('dealer-modal');
    var list = document.getElementById('dealer-selection-list');
    list.innerHTML = '';
    
    players.forEach(function(p) {
        var div = document.createElement('div');
        div.className = 'dealer-select-item';
        div.innerHTML = '<span>' + p + '</span><span class="dealer-order-badge" style="display: none;"></span>';
        div.onclick = function() {
            var badge = div.querySelector('.dealer-order-badge');
            var isSelected = tempDealers.includes(p);
            
            if (isSelected) {
                tempDealers = tempDealers.filter(function(d) { return d !== p; });
                div.classList.remove('selected');
                badge.style.display = 'none';
            } else {
                if (tempDealers.length >= 4) {
                    toast('Maximum 4 dealers');
                    return;
                }
                tempDealers.push(p);
                div.classList.add('selected');
                badge.style.display = 'inline-block';
                badge.textContent = tempDealers.length;
            }
            
            updateDealerBadges();
        };
        list.appendChild(div);
    });
    
    modal.classList.add('show');
}

function updateDealerBadges() {
    var items = document.querySelectorAll('.dealer-select-item');
    items.forEach(function(item) {
        var name = item.querySelector('span').textContent;
        var badge = item.querySelector('.dealer-order-badge');
        var idx = tempDealers.indexOf(name);
        if (idx !== -1) {
            badge.textContent = idx + 1;
        }
    });
}

document.getElementById('btn-confirm-dealers').onclick = function() {
    if (tempDealers.length !== 4) {
        toast('Please select exactly 4 dealers');
        return;
    }
    g.dealers = tempDealers.slice();
    document.getElementById('dealer-modal').classList.remove('show');
    updateUI();
    toast('Dealers set: ' + g.dealers.join(', '));
};

document.getElementById('btn-cancel-dealers').onclick = function() {
    document.getElementById('dealer-modal').classList.remove('show');
    tempDealers = [];
};

document.getElementById('btn-reset-dealers').onclick = function() { if (g.dealers.length === 0) { toast('No dealers'); return; } if (confirm('Reset dealers?')) { g.dealers = []; updateUI(); toast('Dealers reset!'); } };

document.getElementById('btn-save-stakes').onclick = function() { var ns = { game_score: parseFloat(document.getElementById('stake-game').value), bump: parseFloat(document.getElementById('stake-bump').value), points: parseFloat(document.getElementById('stake-points').value), bonus: parseFloat(document.getElementById('stake-bonus').value) }; sb.from('stakes').select('id').limit(1).single().then(function(r) { if (r.data) return sb.from('stakes').update(ns).eq('id', r.data.id); else return sb.from('stakes').insert(ns); }).then(function() { stakes.gameScore = ns.game_score; stakes.bump = ns.bump; stakes.points = ns.points; stakes.bonus = ns.bonus; toast('Stakes saved!'); }); };

function calcScore(w) { var tot = { a: 0, b: 0 }; g.hands.forEach(function(h) { tot.a += h.scoreA; tot.b += h.scoreB; }); var bA = 0, bB = 0; g.hands.forEach(function(h) { if (h.scoreA < 0) bA++; if (h.scoreB < 0) bB++; }); var last = g.hands[g.hands.length - 1], gA = last ? last.scoreA : 0, gB = last ? last.scoreB : 0, fA = 0, fB = 0; if (w === 'A') { var diff = Math.max(0, tot.a - tot.b), base = stakes.gameScore + (bB * stakes.bump), mult = 1; if (gA >= 2 && gA <= 4 && tot.b <= 0) mult = 2; else if (gA === 9 && tot.b >= 1) mult = 2; else if (gA === 9 && tot.b <= 0) mult = 4; else if (gA === 15 && tot.b >= 1) mult = 3; else if (gA === 15 && tot.b <= 0) mult = 6; fA = (base * mult) + (diff * stakes.points); fB = -fA; } else { var diff = Math.max(0, tot.b - tot.a), base = stakes.gameScore + (bA * stakes.bump), mult = 1; if (gB >= 2 && gB <= 4 && tot.a <= 0) mult = 2; else if (gB === 9 && tot.a >= 1) mult = 2; else if (gB === 9 && tot.a <= 0) mult = 4; else if (gB === 15 && tot.a >= 1) mult = 3; else if (gB === 15 && tot.a <= 0) mult = 6; fB = (base * mult) + (diff * stakes.points); fA = -fB; } if (g.teamA.length === 2 && g.teamB.length === 3) fA *= 1.5; else if (g.teamB.length === 2 && g.teamA.length === 3) fB *= 1.5; return { scoreA: fA, scoreB: fB, bumpsA: bA, bumpsB: bB, runningA: tot.a, runningB: tot.b }; }

document.getElementById('btn-end-game').onclick = function() { 
    if (g.hands.length === 0) { 
        alert('No hands played yet! Add scores first.'); 
        return; 
    } 
    var tot = { a: 0, b: 0 }; 
    g.hands.forEach(function(h) { 
        tot.a += h.scoreA; 
        tot.b += h.scoreB; 
    }); 
    if (Math.max(tot.a, tot.b) < 9) { 
        alert('Cannot end game yet!\n\nCurrent scores:\nTeam A: ' + tot.a.toFixed(1) + '\nTeam B: ' + tot.b.toFixed(1) + '\n\nThe winning team needs at least 9 points.'); 
        return; 
    } 
    var wA = calcScore('A'), wB = calcScore('B'), msg = 'SELECT WINNER:\n\nA: Run=' + tot.a.toFixed(1) + ' Final=' + wA.scoreA.toFixed(1) + ' OppBumps=' + wA.bumpsB + '\nB: Run=' + tot.b.toFixed(1) + ' Final=' + wB.scoreB.toFixed(1) + ' OppBumps=' + wB.bumpsA + '\n\nOK=A Cancel=B', choice = confirm(msg), w = choice ? 'A' : 'B', f = choice ? wA : wB; sb.from('games').update({ winner: w === 'A' ? 'TeamA' : 'TeamB', score_a: f.scoreA, score_b: f.scoreB, running_a: f.runningA, running_b: f.runningB, bumps_a: f.bumpsA, bumps_b: f.bumpsB, hands_played: g.hands.length, completed_at: new Date().toISOString() }).eq('id', g.currentGameId).then(function() { var gr = { gameNumber: g.gameNumber, winner: w, scoreA: f.scoreA, scoreB: f.scoreB, handsPlayed: g.hands.length, teamA: g.teamA.slice(), teamB: g.teamB.slice() }; g.completedGames.unshift(gr); g.currentSetGames.push(gr); toast('Game ' + g.gameNumber + ' done! ' + w + ' wins ' + Math.abs(w === 'A' ? f.scoreA : f.scoreB).toFixed(1)); if (g.currentSetGames.length === 3) { var stA = 0, stB = 0; g.currentSetGames.forEach(function(game) { stA += game.scoreA; stB += game.scoreB; }); var aWins = g.currentSetGames.filter(function(game) { return game.winner === 'A'; }).length, bWins = g.currentSetGames.filter(function(game) { return game.winner === 'B'; }).length; if (aWins === 3) { stA += stakes.bonus; stB -= stakes.bonus; toast('A wins all 3! +$' + stakes.bonus); } else if (bWins === 3) { stB += stakes.bonus; stA -= stakes.bonus; toast('B wins all 3! +$' + stakes.bonus); } sb.from('sets').insert({ team_a_players: g.teamA, team_b_players: g.teamB, team_a_score: stA, team_b_score: stB }).then(function() { g.setHistory.unshift({ teamA: g.teamA.slice(), teamB: g.teamB.slice(), teamAScore: stA, teamBScore: stB }); toast('Set done! ' + (stA > stB ? 'A' : 'B') + ' wins!'); g.currentSetGames = []; }); } g.hands = []; sb.from('games').select('game_number').order('game_number', { ascending: false }).limit(1).then(function(r) { var num = r.data && r.data.length > 0 ? r.data[0].game_number + 1 : 1; return sb.from('games').insert({ game_number: num, team_a_players: g.teamA, team_b_players: g.teamB }).select().single(); }).then(function(r) { if (r.data) { g.currentGameId = r.data.id; g.gameNumber = r.data.game_number; } updateUI(); }); }); };

        
load();

document.getElementById('btn-add-score').onclick = function() {
    if (g.dealers.length === 0) {
        if (confirm('Dealers not set! Would you like to select dealers now?')) {
            document.getElementById('btn-dealers').click();
        }
        return;
    }
    document.getElementById('score-a-modal').value = '';
    document.getElementById('score-b-modal').value = '';
    document.getElementById('score-modal').classList.add('show');
    document.getElementById('score-a-modal').focus();
};
        
document.getElementById('btn-confirm-score').onclick = function() {
    var sA = parseFloat(document.getElementById('score-a-modal').value);
    var sB = parseFloat(document.getElementById('score-b-modal').value);
    if (isNaN(sA) || isNaN(sB)) {
        toast('Enter valid scores');
        return;
    }
    var d = g.dealers[g.hands.length % g.dealers.length];
    sb.from('hands').insert({
        game_id: g.currentGameId,
        dealer: d,
        score_a: sA,
        score_b: sB,
        hand_order: g.hands.length
    }).then(function() {
        g.hands.push({ dealer: d, scoreA: sA, scoreB: sB });
        document.getElementById('score-modal').classList.remove('show');
        updateUI();
        toast('Score added!');
    });
};

document.getElementById('btn-cancel-score').onclick = function() {
    document.getElementById('score-modal').classList.remove('show');
};
        
    </script>
</body>
</html>
