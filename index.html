<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitch Game Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #f8f9fa;
            color: #202124;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);
            color: white;
            padding: 1.25rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin: 1.5rem 2rem 0;
            border-bottom: 2px solid #dadce0;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #5f6368;
            border-bottom: 3px solid transparent;
            font-family: inherit;
            position: relative;
            bottom: -2px;
        }
        .tab.active { color: #1a73e8; border-bottom-color: #1a73e8; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            background: #1a73e8;
            color: white;
            margin-right: 0.5rem;
            margin-top: 0.5rem;
        }
        .btn:hover { background: #1557b0; }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #dadce0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            margin-bottom: 0.5rem;
        }
        input:focus { outline: none; border-color: #1a73e8; }
        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            user-select: none;
        }
        .player-item:hover { background: rgba(26, 115, 232, 0.1); }
        .team-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .team-a { background: #e8f5e9; color: #34a853; }
        .team-b { background: #fff3e0; color: #f57c00; }
        .score-display { font-size: 3rem; font-weight: 700; color: #34a853; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #dadce0; }
        th { background: #f8f9fa; font-weight: 600; }
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
        }
        .toast.show { display: block; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ® Pitch Game Tracker</h1>
    </div>

    <div class="tabs">
        <button class="tab active" data-tab="game">Game</button>
        <button class="tab" data-tab="players">Players</button>
        <button class="tab" data-tab="stats">Stats</button>
    </div>

    <div class="container">
        <div id="content-game" class="tab-content active">
            <div class="card">
                <h2>Game #<span id="game-number">1</span></h2>
                <p><strong>Current Dealer:</strong> <span id="current-dealer">Not selected</span></p>
                
                <input type="number" id="score-a" placeholder="Team A Score" step="0.5">
                <input type="number" id="score-b" placeholder="Team B Score" step="0.5">
                
                <button class="btn" id="btn-add-score">Add Score</button>
                <button class="btn" id="btn-dealers" style="background: #34a853;">Select Dealers</button>
                <button class="btn" id="btn-reset-dealers" style="background: #f57c00;">Reset Dealers</button>
                <button class="btn" id="btn-end-game" style="background: #ea4335;">End Game</button>
                
                <h3 style="margin-top: 2rem;">Scores</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                    <div>
                        <h4>Team A</h4>
                        <div class="score-display" id="total-a">0</div>
                        <div id="players-a">No players</div>
                    </div>
                    <div>
                        <h4>Team B</h4>
                        <div class="score-display" id="total-b" style="color: #f57c00;">0</div>
                        <div id="players-b">No players</div>
                    </div>
                </div>
                
                <table>
                    <thead><tr><th>Dealer</th><th>Team A</th><th>Team B</th></tr></thead>
                    <tbody id="hands-table"><tr><td colspan="3">No hands yet</td></tr></tbody>
                </table>

                <div id="total-summary" style="display: none; margin-top: 2rem;">
                    <h3>Total Summary</h3>
                    <table>
                        <thead><tr><th>Team</th><th>Players</th><th>1</th><th>2</th><th>3</th><th>Total</th></tr></thead>
                        <tbody id="summary-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="content-players" class="tab-content">
            <div class="card">
                <h2>Manage Players</h2>
                <input type="text" id="new-player-name" placeholder="Player name" maxlength="8">
                <button class="btn" id="btn-add-player">Add Player</button>
                
                <h3 style="margin-top: 2rem;">Players (Click to assign teams)</h3>
                <div id="player-list"></div>
                <p style="margin-top: 1rem; color: #5f6368; font-size: 0.875rem;">
                    Click: None â†’ Team A â†’ Team B â†’ None
                </p>
            </div>
        </div>

        <div id="content-stats" class="tab-content">
            <div class="card">
                <h2>Statistics</h2>
                <p>Games played: <span id="stat-games">0</span></p>
                <p>Total hands: <span id="stat-hands">0</span></p>
                
                <h3 style="margin-top: 2rem;">Set History</h3>
                <table>
                    <thead><tr><th>Set</th><th>Team A</th><th>Team B</th><th>A Score</th><th>B Score</th><th>Winner</th></tr></thead>
                    <tbody id="set-history-body"><tr><td colspan="6">No sets completed yet</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const sb = window.supabase.createClient(
            'https://lhlnjggrljdgmytmoaqb.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxobG5qZ2dybGpkZ215dG1vYXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjUwNjAsImV4cCI6MjA4MzkwMTA2MH0.61TrFDb3XD14y26_aOhMqcrmgORDnrB7OmRdGlABgKI'
        );

        let game = { players: [], teamA: [], teamB: [], dealers: [], hands: [], gameNumber: 1, currentGameId: null, completedGames: [], setHistory: [], currentSetGames: [] };

        function toast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.onclick = function() {
                const target = this.getAttribute('data-tab');
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('content-' + target).classList.add('active');
            };
        });

        async function loadPlayers() {
            const { data } = await sb.from('players').select('*').order('name');
            game.players = data ? data.map(p => p.name) : [];
        }

        async function loadGame() {
            const { data } = await sb.from('games').select('*').is('winner', null).order('created_at', { ascending: false }).limit(1);
            if (data && data.length > 0) {
                const g = data[0];
                game.currentGameId = g.id;
                game.gameNumber = g.game_number;
                game.teamA = g.team_a_players || [];
                game.teamB = g.team_b_players || [];
                await loadHands(g.id);
            } else {
                await createGame();
            }
        }

        async function createGame() {
            const { data: games } = await sb.from('games').select('game_number').order('game_number', { ascending: false }).limit(1);
            const nextNum = games && games.length > 0 ? games[0].game_number + 1 : 1;
            const { data } = await sb.from('games').insert({ game_number: nextNum, team_a_players: game.teamA, team_b_players: game.teamB }).select().single();
            if (data) {
                game.currentGameId = data.id;
                game.gameNumber = data.game_number;
            }
        }

        async function loadHands(gameId) {
            const { data } = await sb.from('hands').select('*').eq('game_id', gameId).order('hand_order');
            game.hands = data ? data.map(h => ({ dealer: h.dealer, scoreA: parseFloat(h.score_a), scoreB: parseFloat(h.score_b) })) : [];
        }

        async function loadCompleted() {
            const { data } = await sb.from('games').select('*').not('winner', 'is', null).order('completed_at', { ascending: false }).limit(10);
            game.completedGames = data ? data.map(g => ({ gameNumber: g.game_number, winner: g.winner, scoreA: parseFloat(g.score_a), scoreB: parseFloat(g.score_b), handsPlayed: g.hands_played, teamA: g.team_a_players, teamB: g.team_b_players })) : [];
        }

        async function loadSets() {
            const { data } = await sb.from('sets').select('*').order('completed_at', { ascending: false });
            game.setHistory = data ? data.map(s => ({ teamA: s.team_a_players, teamB: s.team_b_players, teamAScore: parseFloat(s.team_a_score), teamBScore: parseFloat(s.team_b_score) })) : [];
        }

        function updateUI() {
            document.getElementById('players-a').textContent = game.teamA.join(', ') || 'No players';
            document.getElementById('players-b').textContent = game.teamB.join(', ') || 'No players';
            
            let totA = 0, totB = 0;
            game.hands.forEach(h => { totA += h.scoreA; totB += h.scoreB; });
            document.getElementById('total-a').textContent = totA.toFixed(1);
            document.getElementById('total-b').textContent = totB.toFixed(1);
            
            const tbody = document.getElementById('hands-table');
            if (game.hands.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">No hands yet</td></tr>';
            } else {
                let rA = 0, rB = 0;
                tbody.innerHTML = game.hands.map(h => {
                    rA += h.scoreA; rB += h.scoreB;
                    return `<tr><td>${h.dealer}</td><td>${rA.toFixed(1)}</td><td>${rB.toFixed(1)}</td></tr>`;
                }).join('');
            }
            
            if (game.dealers.length > 0) {
                document.getElementById('current-dealer').textContent = game.dealers[game.hands.length % game.dealers.length];
            } else {
                document.getElementById('current-dealer').textContent = 'Not selected';
            }
            
            document.getElementById('game-number').textContent = game.gameNumber;
            
            const list = document.getElementById('player-list');
            list.innerHTML = '';
            game.players.forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-item';
                let badge = '';
                if (game.teamA.includes(p)) badge = '<span class="team-badge team-a">Team A</span>';
                else if (game.teamB.includes(p)) badge = '<span class="team-badge team-b">Team B</span>';
                div.innerHTML = `<span>${p}</span>${badge}`;
                div.onclick = () => toggleTeam(p);
                list.appendChild(div);
            });
            
            document.getElementById('stat-games').textContent = game.completedGames.length;
            let th = 0;
            game.completedGames.forEach(g => th += g.handsPlayed || 0);
            document.getElementById('stat-hands').textContent = th;
            
            if (game.currentSetGames.length > 0) {
                document.getElementById('total-summary').style.display = 'block';
                let sA = ['', '', ''], sB = ['', '', ''], tA = 0, tB = 0;
                game.currentSetGames.forEach((g, i) => {
                    sA[i] = g.scoreA.toFixed(1);
                    sB[i] = g.scoreB.toFixed(1);
                    tA += g.scoreA;
                    tB += g.scoreB;
                });
                document.getElementById('summary-body').innerHTML = `
                    <tr><td>A</td><td>${game.teamA.join(', ')}</td><td>${sA[0]}</td><td>${sA[1]}</td><td>${sA[2]}</td><td><strong>${tA.toFixed(1)}</strong></td></tr>
                    <tr><td>B</td><td>${game.teamB.join(', ')}</td><td>${sB[0]}</td><td>${sB[1]}</td><td>${sB[2]}</td><td><strong>${tB.toFixed(1)}</strong></td></tr>
                `;
            }
            
            if (game.setHistory.length > 0) {
                document.getElementById('set-history-body').innerHTML = game.setHistory.map((s, i) => {
                    const w = s.teamAScore > s.teamBScore ? 'Team A' : 'Team B';
                    return `<tr><td>${i + 1}</td><td>${s.teamA.join(', ')}</td><td>${s.teamB.join(', ')}</td><td>${s.teamAScore.toFixed(1)}</td><td>${s.teamBScore.toFixed(1)}</td><td><strong>${w}</strong></td></tr>`;
                }).join('');
            }
        }

        async function toggleTeam(p) {
            const inA = game.teamA.includes(p);
            const inB = game.teamB.includes(p);
            if (!inA && !inB) {
                if (game.teamA.length >= 3) { toast('Team A is full'); return; }
                game.teamA.push(p);
                toast(p + ' â†’ Team A');
            } else if (inA) {
                if (game.teamB.length >= 3) { toast('Team B is full'); return; }
                game.teamA = game.teamA.filter(x => x !== p);
                game.teamB.push(p);
                toast(p + ' â†’ Team B');
            } else {
                game.teamB = game.teamB.filter(x => x !== p);
                toast(p + ' removed');
            }
            if (game.currentGameId) {
                await sb.from('games').update({ team_a_players: game.teamA, team_b_players: game.teamB }).eq('id', game.currentGameId);
            }
            updateUI();
        }

        document.getElementById('btn-add-player').onclick = async () => {
            const n = document.getElementById('new-player-name').value.trim();
            if (!n) { toast('Enter a name'); return; }
            if (game.players.includes(n)) { toast('Player exists'); return; }
            await sb.from('players').insert({ name: n });
            game.players.push(n);
            document.getElementById('new-player-name').value = '';
            updateUI();
            toast(n + ' added!');
        };

        document.getElementById('btn-add-score').onclick = async () => {
            const sA = parseFloat(document.getElementById('score-a').value);
            const sB = parseFloat(document.getElementById('score-b').value);
            if (isNaN(sA) || isNaN(sB)) { toast('Enter valid scores'); return; }
            if (game.dealers.length === 0) { toast('Select dealers first'); return; }
            const d = game.dealers[game.hands.length % game.dealers.length];
            await sb.from('hands').insert({ game_id: game.currentGameId, dealer: d, score_a: sA, score_b: sB, hand_order: game.hands.length });
            game.hands.push({ dealer: d, scoreA: sA, scoreB: sB });
            document.getElementById('score-a').value = '';
            document.getElementById('score-b').value = '';
            updateUI();
            toast('Score added!');
        };

        document.getElementById('btn-dealers').onclick = () => {
            const all = [...game.teamA, ...game.teamB];
            if (all.length < 4) { toast('Need at least 4 players'); return; }
            game.dealers = all.slice(0, 4);
            updateUI();
            toast('Dealers set: ' + game.dealers.join(', '));
        };

        document.getElementById('btn-reset-dealers').onclick = () => {
            if (game.dealers.length === 0) { toast('No dealers to reset'); return; }
            if (confirm('Reset dealers?')) {
                game.dealers = [];
                updateUI();
                toast('Dealers reset!');
            }
        };

        function calcScore(winner) {
            const tot = { a: 0, b: 0 };
            game.hands.forEach(h => { tot.a += h.scoreA; tot.b += h.scoreB; });
            let bA = 0, bB = 0, rA = 0, rB = 0, pA = 0, pB = 0;
            game.hands.forEach(h => {
                rA += h.scoreA; rB += h.scoreB;
                if (rA < pA) bA++;
                if (rB < pB) bB++;
                pA = rA; pB = rB;
            });
            const last = game.hands[game.hands.length - 1];
            const gA = last ? last.scoreA : 0;
            const gB = last ? last.scoreB : 0;
            const st = { gameScore: 4, bump: 2, points: 1 };
            let fA = 0, fB = 0;
            if (winner === 'A') {
                const diff = Math.max(0, tot.a - tot.b);
                const base = st.gameScore + (bB * st.bump);
                let mult = 1;
                if (gA > 1 && gA <= 4 && tot.b <= 0) mult = 2;
                else if (gA === 9 && tot.b >= 1) mult = 2;
                else if (gA === 9 && tot.b <= 0) mult = 4;
                else if (gA === 15 && tot.b >= 1) mult = 3;
                else if (gA === 15 && tot.b <= 0) mult = 6;
                fA = (base * mult) + (diff * st.points);
                fB = -fA;
            } else {
                const diff = Math.max(0, tot.b - tot.a);
                const base = st.gameScore + (bA * st.bump);
                let mult = 1;
                if (gB > 1 && gB <= 4 && tot.a <= 0) mult = 2;
                else if (gB === 9 && tot.a >= 1) mult = 2;
                else if (gB === 9 && tot.a <= 0) mult = 4;
                else if (gB === 15 && tot.a >= 1) mult = 3;
                else if (gB === 15 && tot.a <= 0) mult = 6;
                fB = (base * mult) + (diff * st.points);
                fA = -fB;
            }
            return { scoreA: fA, scoreB: fB, bumpsA: bA, bumpsB: bB, runningA: tot.a, runningB: tot.b };
        }

        document.getElementById('btn-end-game').onclick = async () => {
            if (game.hands.length === 0) { toast('No hands played'); return; }
            const tot = { a: 0, b: 0 };
            game.hands.forEach(h => { tot.a += h.scoreA; tot.b += h.scoreB; });
            if (Math.max(tot.a, tot.b) < 9) { toast('Winner must have at least 9 points'); return; }
            const wA = calcScore('A'), wB = calcScore('B');
            const choice = confirm(`SELECT WINNER:\n\nTeam A:\n- Running: ${tot.a.toFixed(1)}\n- Final: ${wA.scoreA.toFixed(1)}\n- Opp Bumps: ${wA.bumpsB}\n\nTeam B:\n- Running: ${tot.b.toFixed(1)}\n- Final: ${wB.scoreB.toFixed(1)}\n- Opp Bumps: ${wB.bumpsA}\n\nOK=Team A, Cancel=Team B`);
            const w = choice ? 'A' : 'B';
            const f = choice ? wA : wB;
            await sb.from('games').update({ winner: w === 'A' ? 'TeamA' : 'TeamB', score_a: f.scoreA, score_b: f.scoreB, running_a: f.runningA, running_b: f.runningB, bumps_a: f.bumpsA, bumps_b: f.bumpsB, hands_played: game.hands.length, completed_at: new Date().toISOString() }).eq('id', game.currentGameId);
            const gr = { gameNumber: game.gameNumber, winner: w, scoreA: f.scoreA, scoreB: f.scoreB, handsPlayed: game.hands.length, teamA: [...game.teamA], teamB: [...game.teamB] };
            game.completedGames.unshift(gr);
            game.currentSetGames.push(gr);
            toast(`Game ${game.gameNumber} completed! Team ${w} wins ${Math.abs(w === 'A' ? f.scoreA : f.scoreB).toFixed(1)} pts!`);
            if (game.currentSetGames.length === 3) {
                let stA = 0, stB = 0;
                game.currentSetGames.forEach(g => { stA += g.scoreA; stB += g.scoreB; });
                await sb.from('sets').insert({ team_a_players: game.teamA, team_b_players: game.teamB, team_a_score: stA, team_b_score: stB });
                game.setHistory.unshift({ teamA: [...game.teamA], teamB: [...game.teamB], teamAScore: stA, teamBScore: stB });
                toast(`Set complete! ${stA > stB ? 'Team A' : 'Team B'} wins!`);
                game.currentSetGames = [];
            }
            game.hands = [];
            await createGame();
            updateUI();
        };

        async function init() {
            await loadPlayers();
            await loadGame();
            await loadCompleted();
            await loadSets();
            updateUI();
        }

        init();
    </script>
</body>
</html>